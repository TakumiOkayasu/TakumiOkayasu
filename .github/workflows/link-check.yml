name: Link Check

on:
  schedule:
    - cron: "0 9 * * 1"  # æ¯Žé€±æœˆæ›œ 9:00 UTC (18:00 JST)
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "README.md"

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract image URLs from README
        id: extract
        run: |
          grep -oP 'https://[^)"\s]+\.(svg|png|gif|jpg)(\?[^)"\s]*)?' README.md | sort -u > urls.txt
          grep -oP 'src="https://[^"]+' README.md | sed 's/src="//' >> urls.txt
          sort -u urls.txt -o urls.txt
          echo "Found URLs:"
          cat urls.txt

      - name: Check URLs
        run: |
          echo "## Link Check Results" > result.md
          echo "" >> result.md
          failed=0
          
          while IFS= read -r url; do
            # URLã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ç½®æ›
            check_url=$(echo "$url" | sed 's/TakumiOkayasu/TakumiOkayasu/g')
            
            status=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$check_url" || echo "000")
            
            if [[ "$status" =~ ^(200|301|302)$ ]]; then
              echo "âœ… $status - $check_url" >> result.md
            else
              echo "âŒ $status - $check_url" >> result.md
              failed=1
            fi
          done < urls.txt
          
          echo ""
          cat result.md
          
          if [ $failed -eq 1 ]; then
            echo "::warning::Some links are broken. Check the results above."
          fi

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: link-check-results
          path: result.md

      - name: Create issue if links broken
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const result = fs.readFileSync('result.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”— README Link Check Failed',
              body: result,
              labels: ['bug', 'documentation']
            });

